---
title: RG3
subtitle: Response Graphs Comparing BEP vs. Overall Population
---

------------------------------------------------------------------------

::: panel-tabset
## Setup

The same setup as in [RG1](../graphs/rg01.qmd) is used.

For `ggplot()` used in all analyses, we add `by = BMEASIFL` in the aesthetics to support the calculation of proportions using `geom_text(stat = "prop")`.

```{r, message = FALSE}
library(tern)
library(ggplot2.utils)
library(dplyr)

adrs <- scda::synthetic_cdisc_data("rcd_2022_06_27")$adrs %>%
  df_explicit_na() %>%
  mutate(
    AVALC = ordered(AVALC, levels = c("<Missing>", "NE", "PD", "SD", "PR", "CR")),
    AVALC_BIN = fct_collapse_only(
      AVALC,
      Yes = c("CR", "PR"),
      No = c("PD", "SD", "NE", "<Missing>")
    ),
    ARM_BIN = fct_collapse_only(
      ARM,
      Ctrl = c("B: Placebo"),
      Trt = c("A: Drug X", "C: Combination")
    )
  ) %>%
  filter(PARAMCD == "BESRSPI", BMEASIFL == "Y")
```

## Standard Plot

In this example we can use the `facet_grid()` layer with the `margins = TRUE` option to compare the responses between the biomarker evaluable population (BEP) and the overall population.

```{r}
graph <- ggplot(adrs, aes(BMEASIFL, fill = AVALC_BIN, by = BMEASIFL)) +
  geom_bar(position = "fill") +
  geom_text(stat = "prop", position = position_fill(.5), colour = "white") +
  scale_y_continuous(
    labels = scales::percent,
    name = "Proportion %"
  ) +
  scale_x_discrete(labels = NULL) +
  xlab(NULL)

graph +
  facet_grid(BEP01FL ~ ., margins = TRUE)
```

In this example we compare the responses across treatment arms between the biomarker evaluable population and the full population.
We can add the option `margins = TRUE` option within the `facet_grid()` layer to obtain the responses across all treatment arms and their combination within each of the populations.

```{r}
graph +
  facet_grid(BEP01FL ~ ARM_BIN, margins = TRUE)
```

## Response Graph Comparing Subgroups of BEP (RG3A)

In this example we compare the responses across subgroups of the BEP defined by the levels of a categorical biomarker, and overall BEP, again using the `facet_grid()` layer with the option `margins = TRUE`.
We do need to filter first on the BEP flag to restrict the data to the BEP.

```{r}
adrs_bep <- adrs %>%
  filter(BEP01FL == "Y")

graph <- ggplot(adrs_bep, aes(BMEASIFL, fill = AVALC_BIN, by = BMEASIFL)) +
  geom_bar(position = "fill") +
  scale_y_continuous(
    labels = scales::percent,
    name = "Proportion %"
  ) +
  geom_text(stat = "prop", position = position_fill(.5), colour = "white") +
  facet_grid(BMRKR2 ~ ARM_BIN, margins = TRUE)

graph
```

## Plot Counts Instead of Percentages in Response Graph Comparing Subgroups of BEP (RG3B)

In this example we compare the responses across treatment arms between the BEP and the full population using the option `position = "stack"` in the `geom_bar()` layer to display counts instead of percentages.

```{r}
graph <- ggplot(adrs, aes(BMEASIFL, fill = AVALC_BIN, by = BMEASIFL)) +
  geom_bar(position = "stack") +
  scale_x_discrete(labels = NULL) +
  xlab(NULL) +
  geom_text(stat = "count", aes(label = after_stat(count)), position = position_stack(.5), colour = "white") +
  facet_grid(BEP01FL ~ ARM_BIN, margins = TRUE)

graph
```

{{< include ../session_info.qmd >}}
:::
